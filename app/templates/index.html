<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Recommender System Dashboard</title>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #f3f4f6;
            margin: 0;
            padding: 0;
            color: #1f2937;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 40px auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }

        .tab-buttons {
            display: flex;
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-buttons button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            border-right: 1px solid #e5e7eb;
            font-size: 16px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: 0.3s;
        }

        .tab-buttons button:last-child {
            border-right: none;
        }

        .tab-buttons button:hover {
            background: #eff6ff;
            color: #1d4ed8;
        }

        .tab-buttons button.active {
            background: #2563eb;
            color: white;
            border-bottom: 3px solid #1d4ed8;
        }

        .tab-content {
            display: none;
            padding: 25px;
            animation: fadeIn 0.4s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #e5e7eb;
            padding: 10px;
            text-align: center;
        }

        th {
            background: #2563eb;
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background: #f9fafb;
        }

        tr:hover {
            background: #e0e7ff;
        }

        h2,
        h1 {
            color: #1e3a8a;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="tab0">Dataset</button>
            <button class="tab-btn" data-tab="tab1">User-Based CF</button>
            <button class="tab-btn" data-tab="tab2">New Similarity</button>
            <button class="tab-btn" data-tab="tab3">Average Method/ Misery Method </button>
            <button class="tab-btn" data-tab="tab4">Disagreement-Aware</button>

        </div>

        <!-- TAB 0: Dataset -->
        <div id="tab0" class="tab-content active">
            <h1>MovieLens Dataset</h1>
            <p><strong>Total rows:</strong> {{ row_count }}</p>

            <form method="get" id="perPageForm">
                <label for="per_page">Rows per page:</label>
                <select name="per_page" onchange="document.getElementById('perPageForm').submit()">
                    <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
                    <option value="200" {% if per_page==200 %}selected{% endif %}>200</option>
                    <option value="500" {% if per_page==500 %}selected{% endif %}>500</option>
                </select>
            </form>

            {% if data %}
            <table>
                <thead>
                    <tr>{% for key in data[0].keys() %}<th>{{ key }}</th>{% endfor %}</tr>
                </thead>
                <tbody>
                    {% for row in data %}
                    <tr>{% for value in row.values() %}<td>{{ value }}</td>{% endfor %}</tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Pagination -->
            <div style="margin-top:10px;text-align:center;">
                {% if page>1 %}
                <a href="?page={{ page-1 }}&per_page={{ per_page }}">Previous</a>
                {% endif %}
                <span> Page {{ page }} of {{ total_pages }} </span>
                {% if page<total_pages %} <a href="?page={{ page+1 }}&per_page={{ per_page }}">Next</a>
                    {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- TAB 1: User-Based CF -->

        <div id="tab1" class="tab-content">
            <h2>User-Based Collaborative Filtering (Pearson Correlation)</h2>
            <p><em>Predicted movie ratings for multiple users (top 10 users Ã— 5 movies each)</em></p>

            <form method="get" id="cfForm">
                <label for="cf_per_page">Rows per page:</label>
                <select name="cf_per_page" onchange="document.getElementById('cfForm').submit()">
                    <option value="100" {% if cf_per_page==100 %}selected{% endif %}>100</option>
                    <option value="200" {% if cf_per_page==200 %}selected{% endif %}>200</option>
                    <option value="500" {% if cf_per_page==500 %}selected{% endif %}>500</option>
                </select>
                <input type="hidden" name="tab" value="tab1">
            </form>

            {% if predictions %}
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Movie ID</th>
                        <th>Predicted Rating</th>
                        <th>Most Similar User</th>
                        <th>Similarity</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in predictions %}
                    <tr>
                        <td>{{ p.userId }}</td>
                        <td>{{ p.movieId }}</td>
                        <td>{{ p.predicted_rating }}</td>
                        <td>{{ p.similar_user }}</td>
                        <td>{{ p.similarity }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div style="margin-top:10px;text-align:center;">
                {% if cf_page > 1 %}
                <a href="?cf_page={{ cf_page-1 }}&cf_per_page={{ cf_per_page }}&tab=tab1">Previous</a>
                {% endif %}
                <span> Page {{ cf_page }} of {{ cf_total_pages }} </span>
                {% if cf_page < cf_total_pages %} <a
                    href="?cf_page={{ cf_page+1 }}&cf_per_page={{ cf_per_page }}&tab=tab1">Next</a>
                    {% endif %}
            </div>

            {% else %}
            <p style="color:red;">No predictions available.</p>
            {% endif %}
        </div>




        <!-- TAB 2: User Similarities -->
        <div id="tab2" class="tab-content">
            <h2>User Similarities (Top 20 Users)</h2>
            {% if user_similarities and user_similarities|length > 0 %}
            <table>
                <thead>
                    <tr>
                        {% for key in user_similarities[0].keys() %}
                        <th>{{ key }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in user_similarities %}
                    <tr>
                        {% for value in row.values() %}
                        <td>{{ value }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No similarity data available.</p>
            {% endif %}
        </div>




        <!-- TAB 3: Extra -->
        <!-- TAB 3: Group Recommendations -->
        <div id="tab3" class="tab-content">
            <h2>Group Recommendations</h2>
            <p><strong>Group members:</strong> First 5 users in the dataset</p>

            <h3>Average Method (Equal Weight)</h3>
            {% if top_avg_recs %}
            <table>
                <thead>
                    <tr>
                        <th>Movie ID</th>
                        <th>Group Rating (Average)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in top_avg_recs %}
                    <tr>
                        <td>{{ rec.movieId }}</td>
                        <td>{{ rec.predicted_rating|round(2) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color:red;">No group recommendations (average method).</p>
            {% endif %}

            <h3>Least Misery Method (Veto)</h3>
            {% if top_misery_recs %}
            <table>
                <thead>
                    <tr>
                        <th>Movie ID</th>
                        <th>Group Rating (Least Misery)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in top_misery_recs %}
                    <tr>
                        <td>{{ rec.movieId }}</td>
                        <td>{{ rec.predicted_rating|round(2) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color:red;">No group recommendations (least misery method).</p>
            {% endif %}
        </div>

        <!-- TAB 3: Group Recommendations -->
        <div id="tab3" class="tab-content">
            <h2>Group Recommendations</h2>
            <p><strong>Group members:</strong> First 5 users in the dataset</p>

            <p><strong>Total predictions computed:</strong> {{ total_predictions }}</p>

            <h3>Average Method (Equal Weight)</h3>
            {% if top_avg_recs %}
            <table>
                <thead>
                    <tr>
                        <th>Movie ID</th>
                        <th>Average Predicted Rating</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in top_avg_recs %}
                    <tr>
                        <td>{{ rec.movieId }}</td>
                        <td>{{ rec.predicted_rating|round(2) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color:red;">No group recommendations (average method).</p>
            {% endif %}

            <h3>Least Misery Method (Veto)</h3>
            {% if top_misery_recs %}
            <table>
                <thead>
                    <tr>
                        <th>Movie ID</th>
                        <th>Least Misery Rating</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in top_misery_recs %}
                    <tr>
                        <td>{{ rec.movieId }}</td>
                        <td>{{ rec.predicted_rating|round(2) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color:red;">No group recommendations (least misery method).</p>
            {% endif %}
        </div>

        <div id="tab4" class="tab-content">
            <h2>Disagreement-Aware Group Recommendations</h2>

            <p><strong>Idea:</strong> Combine group fairness with disagreement penalty.<br>
                <code>GroupScore = AverageRating - Î± Ã— Variance</code> (Î± = 0.7)
            </p>

            <p><strong>Total Predictions Computed:</strong> {{ total_predictions }}</p>

            {% if top_disagreement_recs %}
            <table>
                <thead>
                    <tr>
                        <th>Movie ID</th>
                        <th>Adjusted Group Score</th>
                        <th>Disagreement (Variance)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in top_disagreement_recs %}
                    <tr>
                        <td>{{ rec.movieId }}</td>
                        <td>{{ rec.group_score|round(2) }}</td>
                        <td>{{ rec.disagreement|round(3) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color:red;">No disagreement-aware group recommendations available.</p>
            {% endif %}
        </div>




    </div>

    <script>
        const buttons = document.querySelectorAll('.tab-btn');
        const contents = document.querySelectorAll('.tab-content');

        buttons.forEach(button => {
            button.addEventListener('click', () => {
                buttons.forEach(btn => btn.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });
    </script>
</body>

</html>

<script>
    const params = new URLSearchParams(window.location.search);
    const activeTab = params.get('tab') || 'tab0';
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(c => {
        c.classList.remove('active');
    });
    document.querySelector(`.tab-btn[data-tab="${activeTab}"]`).classList.add('active');
    document.getElementById(activeTab).classList.add('active');
</script>